jobs:
- job: iOS_Catalyst
  strategy:
    matrix:
      iOS:
        BuildTargetFramework: net9.0-ios
        ArtifactName: iOS
        ApplicationBuildNumberOffset: 50
        BuildCommand: publish
        VersionCodeOffset: 50
        UseSkiaRendering: false
        VariantName: Native
      Catalyst:
        BuildTargetFramework: net9.0-maccatalyst
        ArtifactName: Catalyst
        ApplicationBuildNumberOffset: 50
        BuildCommand: build
        VersionCodeOffset: 50
        UseSkiaRendering: false
        VariantName: Native
      iOS_Skia:
        ArtifactName: iOS
        BuildTargetFramework: net9.0-ios
        ApplicationBuildNumberOffset: 50
        BuildCommand: publish
        VersionCodeOffset: 50
        UseSkiaRendering: true
        VariantName: Skia
      Catalyst_Skia:
        ArtifactName: iOS
        BuildTargetFramework: net9.0-maccatalyst
        ApplicationBuildNumberOffset: 50
        BuildCommand: build
        VersionCodeOffset: 50
        UseSkiaRendering: true
        VariantName: Skia
  pool:
    vmImage: macos-15
  
  variables:
  - group: 'unoplatform.apple.ios.appstore.distribution'

  steps:
  - checkout: self
    clean: true
    fetchDepth: 0
    persistCredentials: true


  - task: InstallAppleCertificate@2
    displayName: Install Certificate
    inputs:
      certSecureFile: UnoPlatform-Apple-Distribution.p12
      certPwd: $(appleappstorecertificatepassword)
      keychain: temp
      # disabled because of azure devops failing to uninstall as of 2022-11-16
      # deleteCert: true

  - task: InstallAppleCertificate@2
    displayName: Install Certificate
    inputs:
      certSecureFile: UnoPlatform-MacInstaller.p12
      certPwd: $(appleappstorecertificatepassword)
      keychain: temp
      # disabled because of azure devops failing to uninstall as of 2022-11-16
      # deleteCert: true

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Chefs_Catalyst.provisionprofile

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Chefs_Canary_Catalyst.provisionprofile

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Chefs_iOS.mobileprovision

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Chefs_Skia_Canary_iOS.mobileprovision

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Chefs_Skia_Catalyst.provisionprofile

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Chefs_Skia_Canary_Catalyst.provisionprofile

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Chefs_Skia_iOS.mobileprovision

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Chefs_Canary_iOS.mobileprovision

  - bash: |
      echo 'Xcode Root to $(XCODE_ROOT)'
      echo '##vso[task.setvariable variable=MD_APPLE_SDK_ROOT;]'$(XCODE_ROOT)
      sudo xcode-select --switch $(XCODE_ROOT)/Contents/Developer

    displayName: Select Xcode

  - template: templates/canary-updater.yml
  - template: templates/gitversion.yml
  - template: templates/dotnet-install-mac.yml
    parameters:
      UnoCheckParameters: '--tfm net9.0-ios --tfm net9.0-maccatalyst'

  - bash: |
      cd $(build.sourcesdirectory)/src/Chefs
      echo "BUILD_SOURCEBRANCH: $BUILD_SOURCEBRANCH"
      dotnet $(BuildCommand) -f $(BuildTargetFramework) /p:TargetFrameworkOverride=$(BuildTargetFramework) -c Release -p:UseSkiaRendering=$(UseSkiaRendering) /p:ArchiveOnBuild=true /bl:$(build.artifactstagingdirectory)/build-$(BuildTargetFramework).binlog "/p:InformationalVersion=$NBGV_InformationalVersion" 
    displayName: Build project for Release - $(BuildTargetFramework)

  - task: CopyFiles@2
    displayName: 'Publish Binaries'
    inputs:
      SourceFolder: $(build.sourcesdirectory)/src/Chefs/bin/Release/
      Contents:  |
        **/*.apk
        **/*.ipa
        **/*.dSym/**
        **/*.pkg
      TargetFolder: $(build.artifactstagingdirectory)
      CleanTargetFolder: false
      OverWrite: false
      flattenFolders: false

  - task: PublishBuildArtifacts@1
    condition: always()
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: $(ArtifactName)-$(VariantName)-is_skia_$(UseSkiaRendering)
      ArtifactType: Container
