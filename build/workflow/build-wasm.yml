jobs:
- job: WASM
  timeoutInMinutes: 90
  pool:
    vmImage: ubuntu-20.04

  container: unoplatform/wasm-build:3.0

  variables:
    SkipUnknownFrameworks: true
  
  steps:
  - task: UseDotNet@2
    retryCountOnTaskFailure: 3
    inputs:
      packageType: sdk
      version: 8.0.100

  - task: UseDotNet@2
    displayName: 'Use .NET Core SDK 5.0.400'
    retryCountOnTaskFailure: 3
    inputs:
      packageType: sdk
      version: 5.0.400
      
  - task: UseDotNet@2
    displayName: 'Use .NET Core SDK 3.1.406'
    retryCountOnTaskFailure: 3
    inputs:
      packageType: sdk
      version: 3.1.406

  - template: templates/canary-updater.yml
  - template: templates/gitversion.yml
  - template: templates/dotnet-install-linux.yml

  - bash: |
      dotnet build /ds /m /r /p:TargetFramework=net8.0-browserwasm /p:Configuration=Release "/p:InformationalVersion=%GITVERSION_InformationalVersion%" src/Chefs/Chefs.csproj /bl:$(build.artifactstagingdirectory)/build-wasm.binlog
    retryCountOnTaskFailure: 3

  - task: CopyFiles@2
    displayName: Copy Wasm output
    inputs:
      SourceFolder: src/Chefs/bin/Release/net8.0-browserwasm/dist
      Contents: '**/*.*'
      TargetFolder: $(build.artifactstagingdirectory)

  - task: CopyFiles@2
    displayName: Copy version information
    inputs:
      Contents: src/Chefs/Version.txt
      TargetFolder: $(build.artifactstagingdirectory)
      FlattenFolders: true

  - task: PublishBuildArtifacts@1
    condition: always()
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: WASM
      ArtifactType: Container