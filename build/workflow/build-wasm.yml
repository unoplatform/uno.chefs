jobs:
- job: WASM
  timeoutInMinutes: 90
  pool:
    vmImage: ubuntu-latest

  container: unoplatform/wasm-build:3.0

  variables:
    SkipUnknownFrameworks: true

  - template: templates/gitversion.yml

  - task: UseDotNet@2
    retryCountOnTaskFailure: 3
    inputs:
      packageType: sdk
      version: 6.0.401

  - template: templates/canary-updater.yml

  - bash: |
      dotnet build /ds /m /r /p:DisableNet6MobileTargets=True /p:Configuration=Release "/p:InformationalVersion=%GITVERSION_InformationalVersion%" src/Chefs.Wasm/Chefs.Wasm.csproj /bl:$(build.artifactstagingdirectory)/build-wasm.binlog
    retryCountOnTaskFailure: 3

  - task: CopyFiles@2
    displayName: Copy Wasm output
    inputs:
      SourceFolder: src/Chefs.Wasm/bin/Release/net6.0/dist
      Contents: '**/*.*'
      TargetFolder: $(build.artifactstagingdirectory)

  - task: CopyFiles@2
    displayName: Copy version information
    inputs:
      Contents: src/Chefs.Wasm/Version.txt
      TargetFolder: $(build.artifactstagingdirectory)
      FlattenFolders: true

  - task: PublishBuildArtifacts@1
    condition: always()
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: WASM
      ArtifactType: Container